<!DOCTYPE html>
<html>
  <head>
    <style>
      .selected {
        border: solid thick yellow;
      }
      .song-box {
        width: 150px;
        height: 150px;
        float: left;
      }
    </style>
  </head>
  <base href="/">
  <body ng-app='tunes'>

    <ng-view></ng-view>
    <svg></svg>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//js.leapmotion.com/0.2.2/leap.js"></script>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/angular-route/angular-route.js"></script>
    <script src="//connect.soundcloud.com/sdk.js"></script>
    <script>
      var tunes = angular.module('tunes', ['ngRoute']);

      tunes.factory('scloud', ['$q', function($q) {
        var deferred = $q.defer();

        SC.initialize({
          client_id: "03df9f6042735bc274cc6c6b27aaf6f7",
          redirect_uri: "http://localhost:8000/callback.html",
        });
        SC.connect(function() {
          SC.get('/me', function(me) {
            deferred.resolve(me);
          });
        });

        return deferred.promise;
      }]);

      tunes.controller('HomeCtrl', ['$scope', 'scloud', function($scope, scloud) {
        $scope.name = 'world';
        $scope.user = {};
        $scope.selectedSong = null;

        var currentSound = null;
        var selectedSongIndex = 0;

        scloud.then(function(me) {
          $scope.user.username = me.username;
          $scope.user.avatarUrl = me.avatar_url;
          SC.get('/playlists', {user_id: me.id}, function(playlists) {
            $scope.$apply(function() {
              var songs = [];
              playlists.forEach(function(playlist) {
                playlist.tracks.forEach(function(track) {
                  songs.push(track);
                });
              })
              $scope.user.songs = songs;
              $scope.selectedSong = songs[0];
              selectedSongIndex = 0;
            });
          });
        });
        var play = function(track) {
          SC.stream("/tracks/" + track.id, function(sound) {
            console.log(sound);
            if (currentSound) {
              currentSound.stop();
            }
            currentSound = sound;
            currentSound.play();
          });
        };

        var ctrl = new Leap.Controller({enableGestures: true});
        var turns = 0;
        var volume = 50;
        var onCircle = function(gesture) {
          if (gesture.normal[2] <= 0 && volume < 100) {
              turns++;
              if (turns % 20 == 0) {
                volume += 5;
                currentSound.setVolume(volume);  
              }
          } else if (volume > 0) {
            turns--;
            if (turns % 20 == 0) {
              volume -= 5;
              currentSound.setVolume(volume);  
            }
          }
        };
        var swipe = 0;
        var onSwipe = function(gesture) {
          var isLeftDir = gesture.direction[0] < 0;
          // out of bounds
          if ((isLeftDir && selectedSongIndex == 0) ||
            (!isLeftDir && selectedSongIndex == $scope.user.songs.length - 1)) {
            return;
          }
          if (isLeftDir) {
            swipe -= 5;
          } else {
            swipe += 5;
          }
          if (swipe % 500 == 0) {
            swipe = 0;
            selectedSongIndex = selectedSongIndex + (isLeftDir ? -1 : 1);
            $scope.$apply(function() {
              $scope.selectedSong = $scope.user.songs[selectedSongIndex];
            });
          }
        };
        ctrl.on('frame', function(frame) {
          frame.gestures.forEach(function(gesture) {
            if (gesture.type == 'screenTap') {
              play($scope.user.songs[selectedSongIndex]);
            }
            else if (gesture.type == 'circle') {
              onCircle(gesture);
            } else if (gesture.type == 'swipe') {
              onSwipe(gesture);
            } 
            
          });
        });
        ctrl.connect();
      }]);

      // config app
      tunes.config(['$locationProvider', function(lp) {
        lp.html5Mode(true);
      }]);
      tunes.config(['$routeProvider', function($routeProvider) {
        $routeProvider.when('/', {
          templateUrl: 'home.ng',
          controller: 'HomeCtrl'
        }).otherwise({
          redirectTo: '/'
        });
      }]);
      
    </script>
    <script>
      // guide from https://github.com/jsantell/browser-dance-party-slides/blob/master/index.html

      var SAMPLE_RATE = 44100;
      var NYQUITS = SAMPLE_RATE / 2;
      var BUFFER_SIZE = 256;
      var FFT_SIZE = BUFFER_SIZE / 2;
      var BIN_COUNT = FFT_SIZE / 2;

      var context = new webkitAudioContext();
      var source = context.createBufferSource();
      var analyser = context.createAnalyser();
      var processor = context.createScriptProcessor(BUFFER_SIZE, 1, 1);
      var fft = new Uint8Array(BIN_COUNT);
      var xScale = d3.scale.linear().domain([1, BIN_COUNT]).range([25, 1000]);
      var yScale = d3.scale.linear().domain([0, 350]).range([10, 600]);
      var svg = d3.select('svg').append('g');
      var rects;

      analyser.fftSize = FFT_SIZE;


      // frequency per bin = nyquits / binCount

      /** event at http://www.w3.org/TR/webaudio/#AudioProcessingEvent-section */
      processor.onaudioprocess = function(event) {
        analyser.getByteFrequencyData(fft);
        requestAnimationFrame(function() {
          rects = svg.selectAll('rect').data(fft);

          rects.enter().
            append('rect').
            attr('x', function(d, i) {
              return xScale(i);
            }).
            attr('width', 975 / BIN_COUNT).
            attr('fill', '#4DA9DF');

            // update
            rects.attr('y', function(d, i) {
              return 600 - yScale(d);
            }).
            attr('height', function(d, i) {
              return yScale(d)
            });
        });
      };

      // Load MP3
      var xhr = new XMLHttpRequest();
      xhr.open('GET', './OneDrop.mp3', true);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function() {
        return;
        context.decodeAudioData(xhr.response, function(decoded) {
          source.buffer = decoded;
          source.connect(analyser);
          analyser.connect(processor);
          processor.connect(context.destination);
          //source.connect(context.destination);
          source.start(0);
        }, function() {
          console.log('error');
          console.log(arguments);
        });
      };
      xhr.send();
    </script>
  </body>
</html>